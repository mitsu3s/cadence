name: Cloud Run CI/CD

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        type: choice
        options:
          - api
          - processor
          - receiver
          - web

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.gen_tag.outputs.image_tag }}

    env:
      PROJECT_ID: cadence-251018
      REGION: asia-northeast1
      AR_REPO: cadence-repository # Artifact Registry の名前
      IMAGE_NAME: cadence-${{ github.event.inputs.service }}  # 引数でサービス名を受け取る

      DOCKERFILE: ${{ github.event.inputs.service }}/Dockerfile
      BUILD_CONTEXT: ./${{ github.event.inputs.service }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      # コミットハッシュからイメージタグを生成
      - name: Generate image tag
        id: gen_tag
        run: |
          TAG=${GITHUB_SHA}
          echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV
          echo "image_tag=$TAG" >> $GITHUB_OUTPUT
          echo "Generated image tag: $TAG"

      # GCP への認証 (Workload Identity Federation)
      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build image
        run: |
          docker build -f ${{ env.DOCKERFILE }} -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:${{ steps.gen_tag.outputs.image_tag }} ${{ env.BUILD_CONTEXT }}

      - name: Push image
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:${{ steps.gen_tag.outputs.image_tag }}

      - name: Output tag
        run: |
          echo "Built and pushed image tag: ${{ steps.gen_tag.outputs.image_tag }}"

  deploy-with-terraform:
    # ビルドとプッシュが完了してからデプロイを実行
    needs: build-and-push-image
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: cadence-251018
      REGION: asia-northeast1

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      # 同じように GCP へ認証
      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init
        working-directory: ./terraform
        run: terraform init -input=false

      # Terraform State から現在のイメージタグを取得
      # デプロイするサービスのタグだけ更新
      - name: Get current image tags
        id: current_tags
        working-directory: ./terraform
        run: |
          API_TAG=$(terraform output -raw api_image_tag 2>/dev/null)
          RECEIVER_TAG=$(terraform output -raw receiver_image_tag 2>/dev/null)
          PROCESSOR_TAG=$(terraform output -raw processor_image_tag 2>/dev/null)
          WEB_TAG=$(terraform output -raw web_image_tag 2>/dev/null)

          case "${{ github.event.inputs.service }}" in
            api)
              API_TAG="${{ needs.build-and-push-image.outputs.image_tag }}"
              ;;
            receiver)
              RECEIVER_TAG="${{ needs.build-and-push-image.outputs.image_tag }}"
              ;;
            processor)
              PROCESSOR_TAG="${{ needs.build-and-push-image.outputs.image_tag }}"
              ;;
            web)
              WEB_TAG="${{ needs.build-and-push-image.outputs.image_tag }}"
              ;;
          esac

          echo "api_tag=$API_TAG" >> $GITHUB_OUTPUT
          echo "receiver_tag=$RECEIVER_TAG" >> $GITHUB_OUTPUT
          echo "processor_tag=$PROCESSOR_TAG" >> $GITHUB_OUTPUT
          echo "web_tag=$WEB_TAG" >> $GITHUB_OUTPUT

      - name: Terraform plan
        working-directory: ./terraform
        run: |
          terraform plan -out=tfplan \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="project_number=${{ secrets.GCP_PROJECT_NUMBER }}" \
            -var="region=${{ secrets.GCP_REGION }}" \
            -var="github_owner=mitsu3s" \
            -var="github_repo=cadence" \
            -var="api_image_tag=${{ steps.current_tags.outputs.api_tag }}" \
            -var="receiver_image_tag=${{ steps.current_tags.outputs.receiver_tag }}" \
            -var="processor_image_tag=${{ steps.current_tags.outputs.processor_tag }}" \
            -var="web_image_tag=${{ steps.current_tags.outputs.web_tag }}" \
            -var="slack_notification_channel=${{ vars.SLACK_NOTIFICATION_CHANNEL }}" \
            -var="firebase_api_key=${{ secrets.FIREBASE_API_KEY }}" \
            -var="firebase_auth_domain=${{ secrets.FIREBASE_AUTH_DOMAIN }}" \
            -var="firebase_project_id=${{ secrets.FIREBASE_PROJECT_ID }}" \
            -var="firebase_storage_bucket=${{ secrets.FIREBASE_STORAGE_BUCKET }}" \
            -var="firebase_messaging_sender_id=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}" \
            -var="firebase_app_id=${{ secrets.FIREBASE_APP_ID }}"

      - name: Terraform apply
        working-directory: ./terraform
        run: terraform apply -auto-approve tfplan
